<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Messenger</title>
    <meta charset="UTF-8">
  </head>
  <body>
    <header>
      <div id="signin_header">
        <input id="user_id" placeholder="username"></input>
        <button id="signin" onclick="signin();">Sign In</button>
        <button id="signup" onclick="signup();">Sign Up</button>
        <span id="signin_error"></span>
      </div>
      <div id="signout_header" class="hide">
        <button id="user_id_display"></button>
        <button id="signout" onclick="signout();">Sign Out</button>
      </div>
    </header>
    <content>
      <div id="messages_wrappers"></div>
      <div id="active_list_wrapper"></div>
    </content>
    <footer></footer>
  </body>
  <style>
    * {
      margin: 0;
      padding: 0;
      outline: none;
      border: 0;
    }
    html, body {
      width: 100%;
      height: 100%;
      font-family: Helvetica, arial, sans-serif;
    }
    .hide {
      display: none;
    }
    #user_id, #user_id_display {
      font-size: 1em;
      width: 10em;
      height: 2em;
      background: #eef;
      padding: 0 0.5em;
    }
    #signup, #signin, #signout {
      margin: 0;
      font-size: 1em;
      background: #ddf;
      width: 5em;
      height: 2em;
    }
    #signup:hover, #signin:hover, #signout:hover {
      background: #aaf;
    }
  </style>
  <script>

    var user_id = "";

		document.getElementById("user_id")
				.addEventListener("keyup", function(event) {
				event.preventDefault();
				if (event.keyCode == 13) {
          document.getElementById("send").click();
				}
		});

		function signup() {
      user_id = document.getElementById("user_id").value;
			sendToServer("signup"+"?user_id="+user_id);
			console.log("signing up: "+user_id);
		}

		function signin() {
      user_id = document.getElementById("user_id").value;
			sendToServer("signin","?user_id="+user_id);
			console.log("signing in: "+user_id);
		}

    function signout() {
			sendToServer("signout","?user_id="+user_id);
      console.log("signed out: "+user_id);
      user_id = "";
    }

    function updateHeader(cmd) {
      if (cmd == "signout") {
        // replace signout_header with signin_header
        document.getElementById("signin_header").setAttribute("class", "hide");
        document.getElementById("signout_header").innerHTML = user_id;
        document.getElementById("signout_header").setAttribute("class", "");
      } else {
        // replace signin_header with signout_header
        document.getElementById("signout_header").setAttribute("class", "hide");
        document.getElementById("signout_header").innerHTML = "";
        document.getElementById("signin_header").setAttribute("class", "");
      }
    }

    function updateChatList() {
      console.log("updating chat list");
    }

    function displayError(msg) {
      document.getElementById("signin_error").innerHTML = msg;
    }

		function sendToServer(cmd, info="") {
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
          var responseText = this.responseText;
          console.log("responseText: "+responseText);
          // signin
          if (cmd == "signin") {
            if (responseText == "true") {
              updateHeader(cmd);
              sendToServer("active_list");
            } else {
              console.log("displaying username not found");
              displayError("Username not found.");
            }
          // signup
          } else if (cmd == "signup") {
            if (responseText == "true") {
              updateHeader(cmd);
              sendToServer("active_list");
            } else {
              console.log("displaying username already exists");
              displayError("Username already exists.");
            }
          } else if (cmd == "signout") {
              updateHeader("signout");
              displayError("Successfully signed out.");
          } else {
            var response = JSON.parse(responseText);
            console.log("parsedResponse: ");
            console.log(response);
            if (cmd == "active_list") {
              updateChatList(response);
            }
          }
        } else if (this.readyState == 4 && this.status == 404) {
          displayError("File not found");
        }
			};
			xhttp.open("GET", cmd+info, true);
			xhttp.send();
		}

  </script>
</html>
